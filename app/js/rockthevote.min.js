angular.module("rockTheVote",["rockTheVote.services","ui.directives"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"partials/view.html",controller:UserViewCtrl});a.when("/election/:id",{templateUrl:"partials/election.html",controller:ElectCtrl});a.when("/election/:id/result",{templateUrl:"partials/result.html",controller:ResultCtrl});a.when("/admin",{templateUrl:"partials/admin.html",controller:AdminViewCtrl});a.when("/admin/edit/:id",{templateUrl:"partials/admin_edit.html",controller:AdminCtrl});
a.when("/admin/manage/:id",{templateUrl:"partials/admin_manage.html",controller:VotesCtrl});a.when("/admin/add",{templateUrl:"partials/admin_edit.html",controller:AdminCtrl});a.otherwise({redirectTo:"/"})}]);angular.module("rockTheVote.services",["ngResource"]).factory("Election",["$resource",function(a){return a("api/election/:eId/:action",{eId:"@id",action:"@action"},{save:{method:"PUT"},getVoters:{method:"GET",params:{action:"voters"},isArray:!0}})}]).factory("Vote",["$resource",function(a){return a("api/voter/:id",{id:"@id"},{save:{method:"PUT"}})}]);function AdminViewCtrl(a,f){a.elections=f.query();a.remove=function(c){(new f).$delete({eId:a.elections[c].id});a.elections.splice(c,1)}}AdminViewCtrl.$inject=["$scope","Election"];function UserViewCtrl(a,f){a.hasPassed=function(a){a=new Date(a);return!isNaN(a.getTime())&&0>a.getTime()-(new Date).getTime()?!0:!1};a.elections=f.query(function(){for(var c=0;c<a.elections.length;c++)a.hasPassed(a.elections[c].start)||a.elections.splice(c,1)})}UserViewCtrl.$inject=["$scope","Election"];
function AdminCtrl(a,f,c,d){a.addPosition=function(){var b=[{name:"",year:null,concentration:""}];a.election.positions?a.election.positions.push({title:"",runners:b}):a.election.positions=[{title:"",runners:b}]};a.removePosition=function(b){a.election.positions.splice(b,1);0==a.election.positions.length&&a.addPosition()};a.addRunner=function(a){a.runners.push({name:"",year:null,concentration:""})};a.removeRunner=function(b,c){b.runners.splice(c,1);0==b.runners.length&&a.addRunner(b)};a.cancel=function(){d.path("/admin")};
a.save=function(){a.election_editor.$valid&&(a.election.notes||(a.election.notes=""),a.election.$save({eId:a.electionId}),d.path("/admin"))};a.electionId=f.id;a.electionId?a.election=c.get({eId:a.electionId},function(){var b=a.election.end;a.election.start=new Date(a.election.start);a.election.end=new Date(b)}):(a.election=new c,a.addPosition())}AdminCtrl.$inject=["$scope","$routeParams","Election","$location"];
function ElectCtrl(a,f,c,d,b){a.electionId=f.id;a.election=d.get({eId:a.electionId});a.email="";a.pickmap={};a.hasClosed=function(a){a=new Date(a);return!isNaN(a.getTime())&&0>a.getTime()-(new Date).getTime()?!0:!1};a.save=function(){var d,e;for(e in a.pickmap)d=new b,d.email=a.email,d.election_id=a.electionId,d.runner_id=parseInt(a.pickmap[e]),d.$save();c.path("/election/"+a.electionId+"/result")}}ElectCtrl.$inject=["$scope","$routeParams","$location","Election","Vote"];
function ResultCtrl(a,f,c){a.electionId=f.id;a.election=c.get({eId:a.electionId},function(){for(var d=0;d<a.election.positions.length;d++){var b=a.election.positions[d];b.showLosers=!1;for(var c=0,e=0;e<b.runners.length;e++)c+=b.runners[e].votes;for(e=0;e<b.runners.length;e++)b.runners[e].percentage=Math.round(1E4*(b.runners[e].votes/c))/100;b.runners.sort(function(a,b){return b.votes-a.votes});b.runners[0].winner=!0;for(e=1;e<b.runners.length;e++)b.runners[e].winner=b.runners[e].votes==b.runners[0].votes?
!0:!1}});a.hasClosed=function(a){a=new Date(a);return!isNaN(a.getTime())&&0>a.getTime()-(new Date).getTime()?!0:!1}}ResultCtrl.$inject=["$scope","$routeParams","Election"];function VotesCtrl(a,f,c,d){a.electionId=f.id;a.voters=c.getVoters({eId:a.electionId});a.remove=function(b){(new d).$delete({id:a.voters[b].id});a.voters.splice(b,1)}}VotesCtrl.$inject=["$scope","$routeParams","Election","Vote"];
